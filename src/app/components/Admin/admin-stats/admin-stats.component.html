<div class="card">
  <!-- Title for the users table -->
  <h2 class="table-title">User List</h2>
  <hr class="divider" />

  <!-- Users table -->
  <p-table #dt [value]="users" dataKey="id" [rows]="3" [rowsPerPageOptions]="[3, 5, 10]" [loading]="loading"
           [paginator]="true" [globalFilterFields]="['email', 'firstname', 'lastname', 'phone', 'status']"
           [tableStyle]="{ 'min-width': '75rem' }">
    <ng-template pTemplate="header">
      <tr>
        <th style="width:15%">Email</th>
        <th style="width:15%">First Name</th>
        <th style="width:15%">Last Name</th>
        <th style="width:15%">Phone</th>
        <th style="width:10%">Status</th>
        <th style="width:10%">Actions</th>
      </tr>
      <tr>
        <th>
          <p-columnFilter type="text" field="email" placeholder="Search by email" ariaLabel="Filter by email">
          </p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="firstname" placeholder="Search by first name" ariaLabel="Filter by first name">
          </p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="lastname" placeholder="Search by last name" ariaLabel="Filter by last name">
          </p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="phone" placeholder="Search by phone" ariaLabel="Filter by phone">
          </p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="status" placeholder="Search by status" ariaLabel="Filter by status">
          </p-columnFilter>
        </th>
        <th></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-user>
      <tr>
        <td>{{ user.email }}</td>
        <td>{{ user.firstname }}</td>
        <td>{{ user.lastname }}</td>
        <td>{{ user.phone }}</td>
        <td>
          <p-tag [severity]="user.status ? 'success' : 'danger'">
            {{ user.status ? 'Active' : 'Blocked' }}
          </p-tag>
        </td>
        <td>
          <button
            pButton
            type="button"
            [label]="user.status ? 'Block' : 'Activate'"
            [severity]="user.status ? 'danger' : 'success'"
            (click)="toggleUserStatus(user)"
          ></button>

        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6">No users found.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Space between tables -->
<div style="margin-top: 2rem;"></div>

<div class="card">
  <!-- Title for the complaints table -->
  <h2 class="table-title">Complaint List</h2>
  <hr class="divider" />

  <!-- Complaints table -->
  <p-table #dt [value]="complaints" dataKey="id" [rows]="3" [rowsPerPageOptions]="[3, 5, 10]" [loading]="loading"
           [paginator]="true" [globalFilterFields]="['description', 'complainer.firstname', 'targetUser.firstname', 'createdAt']"
           [tableStyle]="{ 'min-width': '75rem' }">

    <ng-template pTemplate="header">
      <tr>
        <th style="width:20%">Description</th>
        <th style="width:20%">Complainer</th>
        <th style="width:20%">Targeted Driver</th>
        <th style="width:15%">Date</th>
        <th style="width:10%">Actions</th>
      </tr>
      <tr>
        <th>
          <p-columnFilter type="text" field="description" placeholder="Search by description" ariaLabel="Filter by description">
          </p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="complainer.firstname" placeholder="Search by complainer"
                          ariaLabel="Filter by complainer">
          </p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="targetUser.firstname" placeholder="Search by driver"
                          ariaLabel="Filter by driver">
          </p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="createdAt" placeholder="Search by date" ariaLabel="Filter by date">
          </p-columnFilter>
        </th>
        <th></th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-complaint>
      <tr>
        <td>{{ complaint.description }}</td>
        <td>{{ complaint.complainer.firstname }} {{ complaint.complainer.lastname }}</td>
        <td>{{ complaint.targetUser.firstname }} {{ complaint.targetUser.lastname }}</td>
        <td>{{ complaint.createdAt | date: 'medium' }}</td>
        <td>
          <button
            pButton
            type="button"
            label="View Details"
            severity="info"
            (click)="showComplaintsDetails([complaint])"
          ></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5">No complaints found.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Space between tables -->
<div style="margin-top: 2rem;"></div>

<div class="card">
  <!-- Title for the grouped complaints table -->
  <h2 class="table-title">Complaints Grouped by Targeted User</h2>
  <hr class="divider" />

  <!-- Table with Row Expansion -->
  <p-table [value]="complaintsGroupedByTargetUser" dataKey="targetUser.id" [paginator]="true" [rows]="3" [rowsPerPageOptions]="[3, 5, 10]">
    <!-- Table header -->
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 15%;">Targeted Driver</th>
        <th style="width: 10%;">Role</th>
        <th style="width: 10%;">Status</th>
        <th style="width: 10%;">Number of Complaints</th>
        <th style="width: 55%;">Actions</th>
      </tr>
    </ng-template>

    <!-- Table body -->
    <ng-template pTemplate="body" let-group let-expanded="expanded">
      <tr>
        <td>{{ group.targetUser.firstname }} {{ group.targetUser.lastname }}</td>
        <td>
          <p-tag>{{ group.targetUser.role }}</p-tag>
        </td>
        <td>
          <p-tag [severity]="group.targetUser.status ? 'success' : 'danger'">
            {{ group.targetUser.status ? 'Active' : 'Blocked' }}
          </p-tag>
        </td>
        <td>{{ group.count }}</td>
        <td>

          <button
            pButton
            type="button"
            [label]="group.targetUser.status ? 'Block' : 'Activate'"
            [severity]="group.targetUser.status ? 'danger' : 'success'"
            (click)="toggleUserStatus(group.targetUser)"
          ></button>
          <button
            pButton
            type="button"
            label="View Details"
            severity="info"
            (click)="showComplaintsDetails(group.complaints)"
          ></button>
        </td>
      </tr>
    </ng-template>
    <!-- Row expansion details -->
    <ng-template pTemplate="rowexpansion" let-group>
      <tr>
        <td colspan="5">
          <div class="p-grid p-nogutter">
            <div class="p-col-12">
              <h4>Complaint List</h4>
              <p-table [value]="group.complaints" [responsive]="true">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Description</th>
                    <th>Complainer</th>
                    <th>Date</th>
                    <th>Status</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-complaint>
                  <tr>
                    <td>{{ complaint.description }}</td>
                    <td>{{ complaint.complainer.firstname }} {{ complaint.complainer.lastname }}</td>
                    <td>{{ complaint.createdAt | date: 'medium' }}</td>
                    <td>
                      <p-tag [severity]="complaint.resolved ? 'success' : 'danger'">
                        {{ complaint.resolved ? 'Résolue' : 'Non Résolue' }}
                      </p-tag>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Dialogue pour afficher les détails des plaintes -->
<p-dialog header="Complaint Details" [(visible)]="visible" [modal]="true" [style]="{ width: '50vw' }">
  <p-table [value]="selectedComplaints" [responsive]="true">
    <ng-template pTemplate="header">
      <tr>
        <th>Description</th>
        <th>Complainant</th>
        <th>Date</th>
        <th>Status</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-complaint>
      <tr>
        <td>{{ complaint.description }}</td>
        <td>{{ complaint.complainer.firstname }} {{ complaint.complainer.lastname }}</td>
        <td>{{ complaint.createdAt | date: 'medium' }}</td>
        <td>
          <p-tag [severity]="complaint.resolved ? 'success' : 'danger'">
            {{ complaint.resolved ? 'Resolved' : 'Unresolved' }}
          </p-tag>
        </td>
      </tr>
    </ng-template>
  </p-table>
  <ng-template pTemplate="footer">
    <button pButton type="button" label="Close" (click)="closeDialog()" class="p-button-secondary"></button>
  </ng-template>
</p-dialog>

